# E2E Test Compose File
# Validates that all containers build and pass their health checks
#
# Usage:
#   ./e2e-test.sh           # Run full E2E test
#   docker compose -f docker-compose.e2e.yaml up -d
#   docker compose -f docker-compose.e2e.yaml ps
#   docker compose -f docker-compose.e2e.yaml down -v

services:
  # Base images - just verify they start
  ansible:
    build:
      context: ./ansible
      args:
        VERSION: ${ANSIBLE_VERSION:-latest}
    container_name: e2e-ansible
    command: ["sleep", "infinity"]  # Keep alive for healthcheck

  debian:
    build:
      context: ./debian
    container_name: e2e-debian
    command: ["sleep", "infinity"]  # Keep alive for healthcheck

  # Web servers
  openresty:
    build:
      context: ./openresty
      args:
        VERSION: ${OPENRESTY_VERSION:-latest}
    container_name: e2e-openresty
    ports:
      - "18080:80"

  # Database
  postgres:
    build:
      context: ./postgres
      args:
        VERSION: ${POSTGRES_VERSION:-latest}
    container_name: e2e-postgres
    environment:
      POSTGRES_PASSWORD: e2e_test_password
      POSTGRES_USER: e2e_test
      POSTGRES_DB: e2e_test

  # PHP-FPM
  php:
    build:
      context: ./php
      args:
        VERSION: ${PHP_VERSION:-latest}
    container_name: e2e-php

  # WordPress (PHP-FPM)
  wordpress:
    build:
      context: ./wordpress
      args:
        VERSION: ${WORDPRESS_VERSION:-latest}
    container_name: e2e-wordpress
    environment:
      WORDPRESS_DB_HOST: postgres
      WORDPRESS_DB_USER: e2e_test
      WORDPRESS_DB_PASSWORD: e2e_test_password
      WORDPRESS_DB_NAME: e2e_test
    depends_on:
      - postgres

  # Network services (minimal config for healthcheck)
  sslh:
    build:
      context: ./sslh
      args:
        VERSION: ${SSLH_VERSION:-latest}
    container_name: e2e-sslh
    # SSLH needs a config file, use test mode
    command: ["sslh", "--foreground", "-p", "0.0.0.0:8443", "--ssh", "127.0.0.1:22", "--tls", "127.0.0.1:443"]
    ports:
      - "18443:8443"

  openvpn:
    build:
      context: ./openvpn
      args:
        VERSION: ${OPENVPN_VERSION:-latest}
    container_name: e2e-openvpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    # OpenVPN healthcheck verifies process, not full VPN functionality
