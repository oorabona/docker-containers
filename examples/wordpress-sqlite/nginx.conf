env WP_ADMIN_PATH;

worker_processes auto;
error_log /dev/stderr warn;
pid /var/run/openresty/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Logging
    access_log /dev/stdout;

    # Performance
    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout 65;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Read WP_ADMIN_PATH from environment at startup
    init_by_lua_block {
        admin_path = os.getenv("WP_ADMIN_PATH") or ""
        if admin_path ~= "" then
            local resty_sha256 = require "resty.sha256"
            local resty_string = require "resty.string"
            local sha = resty_sha256:new()
            sha:update(admin_path)
            admin_path_hash = resty_string.to_hex(sha:final())
        else
            admin_path_hash = ""
        end
    }

    # PHP-FPM upstream (WordPress container)
    upstream php-fpm {
        server wordpress:9000;
    }

    server {
        listen 80;
        server_name _;

        root /var/www/html;
        index index.php index.html;

        # Max upload size (WordPress media)
        client_max_body_size 64m;

        # Block xmlrpc.php — common brute-force and DDoS vector
        location = /xmlrpc.php {
            deny all;
        }

        # Block PHP execution in uploads — critical security rule
        location ~* /wp-content/uploads/.*\.php$ {
            deny all;
        }

        # Block access to SQLite database file
        location ~* /wp-content/database/ {
            deny all;
        }

        # Protect wp-login.php when WP_ADMIN_PATH is set
        location = /wp-login.php {
            access_by_lua_block {
                if admin_path ~= "" then
                    local cookie = ngx.var.cookie__wpa
                    if cookie ~= admin_path_hash then
                        return ngx.exit(ngx.HTTP_NOT_FOUND)
                    end
                end
            }
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_buffering on;
            fastcgi_buffer_size 16k;
            fastcgi_buffers 16 16k;
        }

        # Static files
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
            expires 30d;
            access_log off;
            try_files $uri =404;
        }

        # WordPress admin — route directory to wp-admin/index.php (not front controller)
        # When WP_ADMIN_PATH is set, require the entry cookie
        location /wp-admin/ {
            access_by_lua_block {
                if admin_path ~= "" then
                    local cookie = ngx.var.cookie__wpa
                    if cookie ~= admin_path_hash then
                        return ngx.exit(ngx.HTTP_NOT_FOUND)
                    end
                end
            }
            try_files $uri /wp-admin/index.php?$args;
        }

        # WordPress permalinks + secret admin entry point
        location / {
            access_by_lua_block {
                if admin_path ~= "" and ngx.var.uri == "/" .. admin_path then
                    ngx.header["Set-Cookie"] = "_wpa=" .. admin_path_hash .. "; Path=/; HttpOnly; SameSite=Strict; Max-Age=3600"
                    return ngx.redirect("/wp-login.php", ngx.HTTP_MOVED_TEMPORARILY)
                end
            }
            try_files $uri $uri/ /index.php?$args;
        }

        # PHP via FPM
        location ~ \.php$ {
            access_by_lua_block {
                if admin_path ~= "" and ngx.var.uri:find("^/wp%-admin/") then
                    local cookie = ngx.var.cookie__wpa
                    if cookie ~= admin_path_hash then
                        return ngx.exit(ngx.HTTP_NOT_FOUND)
                    end
                end
            }
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_buffering on;
            fastcgi_buffer_size 16k;
            fastcgi_buffers 16 16k;
        }

        # Deny access to sensitive files
        location ~ /\.(ht|git|env) {
            deny all;
        }

        location = /wp-config.php {
            deny all;
        }
    }
}
