#!/bin/bash

# Terraform build script - fetches latest tool versions and updates config.yaml
# config.yaml is the single source of truth for build args

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/config.yaml"

# Source the git-tags helper
source "$SCRIPT_DIR/../helpers/git-tags"
# Source the python-tags helper
source "$SCRIPT_DIR/../helpers/python-tags"

if ! command -v yq >/dev/null 2>&1; then
    echo "ERROR: yq is required to read/update config.yaml" >&2
    exit 1
fi

# Function to get latest TFLint version
get_tflint_version() {
    latest-git-tag terraform-linters tflint | sed 's/^v//'
}

# Function to get latest Trivy version (replacement for deprecated TFSec)
get_trivy_version() {
    latest-git-tag aquasecurity trivy | sed 's/^v//'
}

# Function to get latest Terragrunt version
get_terragrunt_version() {
    latest-git-tag gruntwork-io terragrunt | sed 's/^v//'
}

# Function to get latest Terraform-docs version
get_terraform_docs_version() {
    latest-git-tag terraform-docs terraform-docs | sed 's/^v//'
}

# Function to get latest GitHub CLI version
get_github_cli_version() {
    latest-git-tag cli cli | sed 's/^v//'
}

# Function to get AWS CLI version
get_aws_cli_version() {
    local version=$(get_pypi_latest_version awscli)
    if [[ "$version" == "unknown" ]]; then
        echo "1.34.34"  # Fallback version
    else
        echo "$version"
    fi
}

# Function to get Azure CLI version
get_azure_cli_version() {
    local version=$(get_pypi_latest_version azure-cli)
    if [[ "$version" == "unknown" ]]; then
        echo "2.67.0"  # Fallback version
    else
        echo "$version"
    fi
}

# Function to get GCP CLI version
get_gcp_cli_version() {
    # Google Cloud SDK releases from GitHub
    local version=$(latest-git-tag GoogleCloudPlatform cloud-sdk-docker | sed 's/^v//')
    if [[ -z "$version" || "$version" == "unknown" ]]; then
        echo "latest"
    else
        echo "$version"
    fi
}

# Gather tool versions dynamically
TFLINT_VERSION=$(get_tflint_version)
TRIVY_VERSION=$(get_trivy_version)
TERRAGRUNT_VERSION=$(get_terragrunt_version)
TERRAFORM_DOCS_VERSION=$(get_terraform_docs_version)
GITHUB_CLI_VERSION=$(get_github_cli_version)
AWS_CLI_VERSION=$(get_aws_cli_version)
AZURE_CLI_VERSION=$(get_azure_cli_version)
GCP_CLI_VERSION=$(get_gcp_cli_version)

echo "Building Terraform ${VERSION} with tools:"
echo "  TFLint: ${TFLINT_VERSION}"
echo "  Trivy: ${TRIVY_VERSION}"
echo "  Terragrunt: ${TERRAGRUNT_VERSION}"
echo "  Terraform-docs: ${TERRAFORM_DOCS_VERSION}"
echo "  GitHub CLI: ${GITHUB_CLI_VERSION}"
echo "  AWS CLI: ${AWS_CLI_VERSION}"
echo "  Azure CLI: ${AZURE_CLI_VERSION}"
echo "  GCP CLI: ${GCP_CLI_VERSION}"

# Update config.yaml with fetched versions (single source of truth)
yq -i ".build_args.TFLINT_VERSION = \"${TFLINT_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.TRIVY_VERSION = \"${TRIVY_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.TERRAGRUNT_VERSION = \"${TERRAGRUNT_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.TERRAFORM_DOCS_VERSION = \"${TERRAFORM_DOCS_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.GITHUB_CLI_VERSION = \"${GITHUB_CLI_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.AWS_CLI_VERSION = \"${AWS_CLI_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.AZURE_CLI_VERSION = \"${AZURE_CLI_VERSION}\"" "$CONFIG_FILE"
yq -i ".build_args.GCP_CLI_VERSION = \"${GCP_CLI_VERSION}\"" "$CONFIG_FILE"

echo "Updated config.yaml with latest tool versions"

# No CUSTOM_BUILD_ARGS needed â€” build-container.sh reads config.yaml directly
