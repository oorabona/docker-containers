#!/bin/bash

# Pre-build script for OpenResty
# Sets dynamic build arguments not in config.yaml
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if ! command -v yq >/dev/null 2>&1; then
    echo "ERROR: yq is required to read config.yaml" >&2
    exit 1
fi

# Get raw upstream version (without -alpine suffix) for source download
RESTY_VERSION=$("$SCRIPT_DIR/version.sh" --upstream)

echo "Building OpenResty ${VERSION} (source: ${RESTY_VERSION})"

# Append dynamic args to CUSTOM_BUILD_ARGS (preserve existing cache overrides)
# Note: static args (RESTY_OPENSSL_VERSION, etc.) are read from config.yaml build_args
CUSTOM_BUILD_ARGS="${CUSTOM_BUILD_ARGS:+$CUSTOM_BUILD_ARGS }--build-arg RESTY_VERSION=${RESTY_VERSION}"
CUSTOM_BUILD_ARGS+=" --build-arg ENABLE_HTTP_PROXY_CONNECT=false"

export CUSTOM_BUILD_ARGS
