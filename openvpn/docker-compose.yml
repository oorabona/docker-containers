services:
  openvpn:
    build:
      context: .
      network: host
      args:
        VERSION: ${VERSION:-latest}
        OS_VERSION: ${OS_VERSION:-latest}
        NPROC: ${NPROC:-1}
    image: ${DOCKER_REGISTRY:-}openvpn:${TAG:-latest}
    ports:
      - "1194:1194/udp"
    # Required capabilities for VPN
    cap_add:
      - NET_ADMIN
      - NET_RAW
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    devices:
      - /dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.forwarding=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
    environment:
      - AUTO_INSTALL=${AUTO_INSTALL:-n}
      - AUTO_START=${AUTO_START:-y}
    volumes:
      - openvpn_config:/etc/openvpn
    restart: unless-stopped

volumes:
  openvpn_config:
