name: Build Container
description: Smart container build with multi-platform and multi-registry support
inputs:
  container:
    description: Container name to build
    required: true
  version:
    description: Version to build (if empty, will be auto-detected)
    required: false
    default: ''
  platform:
    description: Target platform (e.g., linux/amd64 or linux/arm64)
    required: false
    default: 'linux/amd64'
  force_rebuild:
    description: Force rebuild even if image exists
    required: false
    default: 'false'
  dockerhub_username:
    description: Docker Hub username
    required: false
  dockerhub_token:
    description: Docker Hub token
    required: false
  github_token:
    description: GitHub token for GHCR
    required: true
  scan_vulnerabilities:
    description: Enable Trivy vulnerability scanning (true/false)
    required: false
    default: 'true'
  vulnerability_severity:
    description: Minimum severity to fail build (CRITICAL, HIGH, MEDIUM, LOW)
    required: false
    default: 'CRITICAL'
outputs:
  built:
    description: Whether the container was built
    value: ${{ steps.check-build.outputs.needs_build }}
  version:
    description: Container version that was built
    value: ${{ steps.check-build.outputs.current_version }}
  image_name:
    description: Full image name
    value: ${{ steps.check-build.outputs.image_name }}
  ghcr_pushed:
    description: Whether GHCR push succeeded
    value: ${{ steps.push-ghcr.outputs.success }}
  dockerhub_pushed:
    description: Whether Docker Hub push succeeded
    value: ${{ steps.push-dockerhub.outputs.success }}
  scan_passed:
    description: Whether security scan passed (or was skipped)
    value: ${{ steps.trivy-scan.outcome != 'failure' || inputs.scan_vulnerabilities != 'true' }}
runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      # Uses docker-container driver (default) which supports --push
      # GitHub runners cache moby/buildkit images, so Docker Hub dependency is minimal
      # Retry logic handles intermittent Docker Hub issues

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}

    - name: Log in to Docker Hub
      if: ${{ inputs.dockerhub_username != '' && inputs.dockerhub_token != '' }}
      id: dockerhub-login
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ inputs.dockerhub_username }}
        password: ${{ inputs.dockerhub_token }}
      continue-on-error: true

    - name: Check if build is needed and get version
      id: check-build
      shell: bash
      run: |
        set -e
        container="${{ inputs.container }}"

        # Check if the container directory exists and has a Dockerfile
        if [[ ! -f "$container/Dockerfile" ]]; then
          echo "::error::No Dockerfile found for $container"
          echo "needs_build=false" >> $GITHUB_OUTPUT
          echo "current_version=latest" >> $GITHUB_OUTPUT
          echo "image_name=${{ github.repository_owner }}/${container}" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Set image names
        github_username="${{ github.repository_owner }}"
        image_name="${github_username}/${container}"

        # Get current version for tagging
        # Priority: 1) input version, 2) ./make version, 3) fallback to "latest"
        current_version="${{ inputs.version }}"

        if [[ -n "$current_version" && "$current_version" != "unknown" && "$current_version" != "latest" ]]; then
          echo "::notice::Using provided version: $current_version"
        elif current_version=$(./make version "$container" 2>/dev/null); then
          if [[ -n "$current_version" && "$current_version" != "unknown" ]]; then
            echo "::notice::Detected version: $current_version"
          else
            current_version="latest"
            echo "::notice::Using fallback version: $current_version"
          fi
        else
          current_version="latest"
          echo "::notice::Using fallback version: $current_version"
        fi

        # Determine if build is needed
        if [ "${{ inputs.force_rebuild }}" = "true" ]; then
          echo "::notice::Force rebuild requested"
          needs_build=true
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "::notice::Code changes detected - build needed"
          needs_build=true
        else
          echo "::notice::Manual/scheduled build"
          needs_build=true
        fi

        echo "needs_build=$needs_build" >> $GITHUB_OUTPUT
        echo "current_version=$current_version" >> $GITHUB_OUTPUT
        echo "image_name=$image_name" >> $GITHUB_OUTPUT

    - name: Build container
      if: ${{ steps.check-build.outputs.needs_build == 'true' }}
      id: build
      shell: bash
      run: |
        set -e
        # Export BUILD_PLATFORM explicitly (composite action env interpolation workaround)
        export BUILD_PLATFORM="${{ inputs.platform }}"
        container="${{ inputs.container }}"
        current_version="${{ steps.check-build.outputs.current_version }}"

        echo "::group::Building $container:$current_version for $BUILD_PLATFORM"
        chmod +x make

        if ! ./make build "$container" "$current_version"; then
          echo "::error::Build failed for $container"
          exit 1
        fi

        echo "::endgroup::"
        echo "::notice::Build successful for $container:$current_version"

    # Security Scanning with Trivy
    # Note: Image is tagged as ghcr.io/owner/container:version by the build step
    - name: Cache Trivy vulnerability database
      if: ${{ steps.check-build.outputs.needs_build == 'true' && inputs.scan_vulnerabilities == 'true' }}
      uses: actions/cache@v4
      with:
        path: ~/.cache/trivy
        key: trivy-db-${{ runner.os }}-${{ hashFiles('.github/actions/build-container/action.yaml') }}
        restore-keys: |
          trivy-db-${{ runner.os }}-

    - name: Scan for vulnerabilities (Trivy)
      if: ${{ steps.check-build.outputs.needs_build == 'true' && inputs.scan_vulnerabilities == 'true' }}
      id: trivy-scan
      uses: aquasecurity/trivy-action@0.29.0
      with:
        image-ref: 'ghcr.io/${{ steps.check-build.outputs.image_name }}:${{ steps.check-build.outputs.current_version }}'
        format: 'table'
        exit-code: '1'
        severity: '${{ inputs.vulnerability_severity }},CRITICAL'
        ignore-unfixed: true
        vuln-type: 'os,library'
        cache-dir: ~/.cache/trivy
      continue-on-error: true  # Scan is advisory - don't block builds on scan failures

    - name: Generate SARIF report
      if: ${{ steps.check-build.outputs.needs_build == 'true' && inputs.scan_vulnerabilities == 'true' && always() }}
      uses: aquasecurity/trivy-action@0.29.0
      with:
        image-ref: 'ghcr.io/${{ steps.check-build.outputs.image_name }}:${{ steps.check-build.outputs.current_version }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'LOW,MEDIUM,HIGH,CRITICAL'
        ignore-unfixed: true
        vuln-type: 'os,library'
        cache-dir: ~/.cache/trivy
      continue-on-error: true

    - name: Upload SARIF to GitHub Security
      if: ${{ steps.check-build.outputs.needs_build == 'true' && inputs.scan_vulnerabilities == 'true' && always() }}
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'container-${{ inputs.container }}'
        wait-for-processing: false
      continue-on-error: true  # Don't fail if SARIF upload fails (file may not exist)

    - name: Check scan result
      if: ${{ steps.check-build.outputs.needs_build == 'true' && inputs.scan_vulnerabilities == 'true' && github.event_name != 'pull_request' }}
      shell: bash
      continue-on-error: true  # Security scan is advisory, not blocking
      run: |
        if [ "${{ steps.trivy-scan.outcome }}" = "failure" ]; then
          echo "::warning::Security scan found vulnerabilities above threshold"
          echo "::warning::Review the scan results above - this is advisory only"
        else
          echo "::notice::Security scan passed - no blocking vulnerabilities found"
        fi

    # GHCR Push - PRIMARY REGISTRY (required)
    - name: Push to GHCR (primary)
      if: ${{ steps.check-build.outputs.needs_build == 'true' && github.event_name != 'pull_request' }}
      id: push-ghcr
      shell: bash
      run: |
        set -e
        # Export BUILD_PLATFORM explicitly (composite action env interpolation workaround)
        export BUILD_PLATFORM="${{ inputs.platform }}"
        container="${{ inputs.container }}"
        current_version="${{ steps.check-build.outputs.current_version }}"

        echo "::notice::Pushing with BUILD_PLATFORM=$BUILD_PLATFORM"
        echo "::group::Pushing to GHCR (primary registry)"

        if ./make push ghcr "$container" "$current_version"; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "::notice::GHCR push successful"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::error::GHCR push failed"
          exit 1
        fi

        echo "::endgroup::"

    # Docker Hub Push - SECONDARY REGISTRY (optional, can fail)
    - name: Push to Docker Hub (secondary)
      if: ${{ steps.check-build.outputs.needs_build == 'true' && github.event_name != 'pull_request' && steps.dockerhub-login.outcome == 'success' }}
      id: push-dockerhub
      shell: bash
      run: |
        # Export BUILD_PLATFORM explicitly (composite action env interpolation workaround)
        export BUILD_PLATFORM="${{ inputs.platform }}"
        container="${{ inputs.container }}"
        current_version="${{ steps.check-build.outputs.current_version }}"

        echo "::group::Pushing to Docker Hub (secondary registry)"

        if ./make push dockerhub "$container" "$current_version"; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "::notice::Docker Hub push successful"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "::warning::Docker Hub push failed - images available on GHCR only"
        fi

        echo "::endgroup::"
      continue-on-error: true

    - name: Skip push for pull request
      if: ${{ steps.check-build.outputs.needs_build == 'true' && github.event_name == 'pull_request' }}
      shell: bash
      run: |
        echo "::notice::Skipping push (pull request - test build only)"
