---
name: Validate Version Scripts
on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**/version.sh'
      - .github/workflows/upstream-monitor.yaml
      - .github/actions/check-upstream-versions/**
permissions:
  contents: read
jobs:
  validate-version-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Verify dependencies
        run: |
          # Verify that required dependencies are available
          # curl and git are pre-installed on ubuntu-latest runners, but let's confirm
          echo "✅ Verifying dependencies..."
          echo "- jq: $(jq --version)"
          echo "- curl: $(curl --version | head -1)"
          echo "- git: $(git --version)"

          # Verify all dependencies are available
          command -v jq >/dev/null 2>&1 || { echo "❌ jq not found" && exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "❌ curl not found" && exit 1; }
          command -v git >/dev/null 2>&1 || { echo "❌ git not found" && exit 1; }
          echo "✅ All dependencies verified and ready"
      - name: Make scripts executable
        run: |
          chmod +x make
          chmod +x test-version-scripts.sh
          find . -name "version.sh" -exec chmod +x {} \;
      - name: Test all version.sh scripts
        run: |
          ./test-version-scripts.sh
      - name: Test upstream monitoring action
        uses: ./.github/actions/check-upstream-versions
        with:
          container: wordpress
      - name: Display test results
        run: |-
          echo "## 🧪 Version Script Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All version.sh scripts have been tested and validated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ What was tested:" >> $GITHUB_STEP_SUMMARY
          echo "- Each version.sh script can retrieve latest upstream versions" >> $GITHUB_STEP_SUMMARY
          echo "- Each version.sh script can validate specific versions" >> $GITHUB_STEP_SUMMARY
          echo "- The upstream monitoring action works correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Integration with the existing make script infrastructure" >> $GITHUB_STEP_SUMMARY
